import React, { useState, useEffect, useRef } from 'react';
import FeedbackForm from './FeedbackForm';
import sampleData from '../data/feedback-data.json';

const StudentDashboard = ({ user, onLogout, onSwitchDashboard }) => {
  const [activeForm, setActiveForm] = useState(null);
  const [pendingForms, setPendingForms] = useState(sampleData?.pendingForms || []);
  const [completedForms, setCompletedForms] = useState(sampleData?.completedForms || []);
  const [showSuccess, setShowSuccess] = useState(false);
  // student profile state (persisted locally)
  // use a per-user storage key so multiple users on same browser don't overwrite each other
  const BASE_KEY = 'sfs_student_profile';
  const STORAGE_KEY = `${BASE_KEY}_${(user && (user.id || user.email)) ? String(user.id || user.email).replace(/[^a-zA-Z0-9_-]/g, '') : 'guest'}`;
  // normalize initial profile values: prefer clean studentId (before @) and email separated
  const normalizeInitialProfile = (u) => {
    const out = { name: '', studentId: '', email: '', photoUrl: '', course: '' };
    if (!u) return out;
    // email
    if (u.email && u.email.includes('@')) out.email = u.email;
    else if (u.id && u.id.includes('@')) out.email = u.id;

    // studentId: prefer part before @ if id is an email, else use id as-is
    if (u.id) {
      if (typeof u.id === 'string' && u.id.includes('@')) {
        out.studentId = u.id.split('@')[0];
      } else {
        out.studentId = String(u.id);
      }
    }

    // name: use provided name unless it looks autogenerated like 'Student <email>' or equals the email
    if (u.name && typeof u.name === 'string') {
      const nameLower = u.name.toLowerCase();
      const emailLower = (out.email || '').toLowerCase();
      if (nameLower && !nameLower.includes(emailLower) && nameLower !== out.studentId) out.name = u.name;
    }

    return out;
  };

  const [profile, setProfile] = useState(() => ({
    ...normalizeInitialProfile(user),
    photoUrl: '',
    course: '',
  }));
  const [editing, setEditing] = useState(false);
  const [passwordUpdate, setPasswordUpdate] = useState({ current: '', newPass: '', confirm: '' });
  const [showProfileDropdown, setShowProfileDropdown] = useState(false);
  const dropdownRef = useRef(null);

  const [showEditModal, setShowEditModal] = useState(false);

  useEffect(() => {
    try {
      // try per-user key first
      let raw = localStorage.getItem(STORAGE_KEY);
      // fallback: if legacy global key exists, migrate it to per-user key
      if (!raw) {
        const legacy = localStorage.getItem(BASE_KEY);
        if (legacy) {
          raw = legacy;
          try { localStorage.setItem(STORAGE_KEY, legacy); } catch (e) { /* ignore write error */ }
        }
      }
      if (raw) {
        const saved = JSON.parse(raw);
        setProfile(prev => ({ ...prev, ...saved }));
      }
    } catch (e) {
      // ignore
    }
  }, [STORAGE_KEY]);

  useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
    } catch (e) {
      // ignore
    }
  }, [profile, STORAGE_KEY]);

  // close dropdown when clicking outside
  useEffect(() => {
    const onDocClick = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setShowProfileDropdown(false);
      }
    };
    if (showProfileDropdown) document.addEventListener('click', onDocClick);
    return () => document.removeEventListener('click', onDocClick);
  }, [showProfileDropdown]);

  const getUserDisplayName = (email) => {
    if (profile?.name) return profile.name;
    if (!email) return 'Student';
    const namePart = email.split('@')[0];
    return isNaN(namePart) ? namePart : `Student ${namePart}`;
  };

  const getInitials = (name) => {
    if (!name) return null;
    const parts = name.trim().split(/\s+/);
    if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  };

  const handleStartFeedback = (form) => {
    setActiveForm(form);
  };

  const handleSubmitFeedback = (formId, responses) => {
    console.log(`Feedback submitted for form ${formId}:`, responses);
    
    const submittedForm = pendingForms.find(f => f.id === formId);
    setPendingForms(pendingForms.filter(f => f.id !== formId));
    setCompletedForms([...completedForms, { ...submittedForm, status: 'completed', date: `Completed: ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}` }]);
    
    setActiveForm(null);
    setShowSuccess(true);
    setTimeout(() => setShowSuccess(false), 3000);
  };

  const handleCancelFeedback = () => {
    setActiveForm(null);
  };

  if (activeForm) {
    return (
      <FeedbackForm 
        form={activeForm} 
        onSubmit={handleSubmitFeedback}
        onCancel={handleCancelFeedback}
      />
    );
  }

  return (
    <div className="dashboard">
      <header className="dashboard-header" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
        <div>
          <h1>Student Dashboard</h1>
          <p>Welcome, {getUserDisplayName(user.id)}!</p>
        </div>

        <div style={{position: 'relative'}} ref={dropdownRef}>
          <button onClick={() => setShowProfileDropdown(s => !s)} style={{width: 44, height: 44, borderRadius: 22, border: 'none', background: '#eef2ff', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center'}} title="Profile">
            {profile.photoUrl ? (
              // eslint-disable-next-line jsx-a11y/img-redundant-alt
              <img src={profile.photoUrl} alt="avatar" style={{width: '100%', height: '100%', objectFit: 'cover', borderRadius: 22}} />
            ) : (
              (getInitials(profile.name)) ? (
                <span style={{fontWeight: 700, color: '#0b1220'}}>{getInitials(profile.name)}</span>
              ) : (
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#0b1220" opacity="0.9"/>
                  <path d="M3 21c0-3.866 3.582-7 9-7s9 3.134 9 7v1H3v-1z" fill="#0b1220" opacity="0.6"/>
                </svg>
              )
            )}
          </button>

          {showProfileDropdown && (
            <div style={{position: 'absolute', right: 0, marginTop: 8, width: 320, background: '#fff', border: '1px solid #eef2f7', borderRadius: 8, boxShadow: '0 8px 24px rgba(2,6,23,0.08)', padding: 12, zIndex: 40}}>
              <div>
                <div style={{display: 'flex', gap: 12, alignItems: 'center'}}>
                  <div style={{width: 56, height: 56, borderRadius: 8, overflow: 'hidden', background: '#f8fafc', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                    {profile.photoUrl ? (
                      // eslint-disable-next-line jsx-a11y/img-redundant-alt
                      <img src={profile.photoUrl} alt="avatar" style={{width: '100%', height: '100%', objectFit: 'cover'}} />
                    ) : (
                      <div style={{fontWeight: 700, color: '#64748b'}}>{getInitials(profile.name) || 'U'}</div>
                    )}
                  </div>
                  <div style={{flex: 1}}>
                    <div style={{fontWeight: 700}}>{profile.name || getUserDisplayName(user.id)}</div>
                    <div style={{fontSize: 13, color: '#475569'}}>{profile.email || 'No email'}</div>
                    <div style={{fontSize: 12, color: '#94a3b8', marginTop: 6}}>{profile.course || 'Course / Branch not set'}</div>
                  </div>
                </div>

                <div style={{display: 'flex', gap: 8, marginTop: 12}}>
                  <button className="action-btn" onClick={() => { setShowProfileDropdown(false); setShowEditModal(true); setEditing(true); }}>Edit Profile</button>
                  <button className="action-btn" onClick={() => { const cur = prompt('Enter current password (demo)'); const np = prompt('Enter new password'); if (np) alert('Password updated locally (demo)'); }}>Update Password</button>
                  <button className="action-btn" onClick={() => { setShowProfileDropdown(false); onLogout && onLogout(); }} style={{marginLeft: 'auto'}}>Logout</button>
                </div>
              </div>
            </div>
          )}
        </div>
      </header>

      {/* Edit profile modal (centered) */}
      {showEditModal && (
        <div style={{position: 'fixed', inset: 0, background: 'rgba(2,6,23,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 60}} onClick={() => { setShowEditModal(false); setEditing(false); }}>
          <div style={{width: 420, background: '#fff', borderRadius: 10, padding: 16, boxShadow: '0 12px 40px rgba(2,6,23,0.16)'}} onClick={(e) => e.stopPropagation()}>
            <h3 style={{marginTop: 0}}>Edit Profile</h3>
                  <div style={{display: 'grid', gap: 8}}>
                    <label style={{fontSize: 13, fontWeight: 600}}>Full name</label>
                    <input placeholder="Full name" value={profile.name} onChange={(e) => setProfile(p => ({...p, name: e.target.value}))} />

                    <label style={{fontSize: 13, fontWeight: 600}}>Student ID</label>
                    <input placeholder="e.g. 2400032573" value={profile.studentId} onChange={(e) => {
                      // keep only allowed ID characters (basic)
                      const v = e.target.value.replace(/[^a-zA-Z0-9_-]/g, '');
                      setProfile(p => ({...p, studentId: v}));
                    }} />

                    <label style={{fontSize: 13, fontWeight: 600}}>Email</label>
                    <input placeholder="your@school.edu" value={profile.email} onChange={(e) => setProfile(p => ({...p, email: e.target.value}))} />

                    <label style={{fontSize: 13, fontWeight: 600}}>Course / Branch</label>
                    <input placeholder="Course / Branch" value={profile.course} onChange={(e) => setProfile(p => ({...p, course: e.target.value}))} />

                    {/* photo URL input removed per request; avatar still supports profile.photoUrl if present */}
              <div style={{display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 8}}>
                <button className="action-btn" onClick={() => { setEditing(false); setShowEditModal(false); }}>Cancel</button>
                <button className="action-btn" onClick={() => {
                  // basic validation: studentId should exist; email should contain @ if present
                  if (!profile.studentId) {
                    alert('Please provide a valid Student ID.');
                    return;
                  }
                  if (profile.email && !profile.email.includes('@')) {
                    alert('Please provide a valid email address.');
                    return;
                  }
                  // persist happens via effect monitoring profile; just close modal
                  setEditing(false);
                  setShowEditModal(false);
                }}>Save</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {showSuccess && (
        <div className="success-message">
          ‚úì Feedback submitted!
        </div>
      )}

      <main className="dashboard-content">
        <section className="forms-section">
          <h2>
            Pending Feedback 
            <span className="badge">{pendingForms.length}</span>
          </h2>
          <p className="section-description">Forms waiting for your response</p>
          <div className="forms-grid">
            {pendingForms.map(form => (
              <div key={form.id} className="form-card pending">
                <div className="form-header">
                  <h3>{form.title}</h3>
                  <span className="course-code">{form.course}</span>
                </div>
                <p className="instructor">Instructor: {form.instructor}</p>
                <p className="form-description">{form.description}</p>
                <div className="form-meta">
                  <span>‚è± {form.duration} min</span>
                  <span>üìÖ {form.date}</span>
                </div>
                <button 
                  onClick={() => handleStartFeedback(form)}
                  className="start-btn"
                >
                  Start Feedback
                </button>
              </div>
            ))}
          </div>
        </section>

        <section className="completed-section">
          <h2>Completed Feedback</h2>
          <p className="section-description">Forms you've submitted</p>
          <div className="forms-grid">
            {completedForms.map(form => (
              <div key={form.id} className="form-card completed">
                <div className="form-header">
                  <h3>{form.title}</h3>
                  <span className="course-code">{form.course}</span>
                </div>
                <p className="instructor">Instructor: {form.instructor}</p>
                <p className="form-description">{form.description}</p>
                <div className="form-meta">
                  <span>‚è± {form.duration} min</span>
                  <span>‚úÖ {form.date}</span>
                </div>
                <div className="completed-badge">Submitted</div>
              </div>
            ))}
          </div>
        </section>
      </main>
    </div>
  );
};

export default StudentDashboard;